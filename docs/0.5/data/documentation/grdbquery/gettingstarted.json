{"seeAlsoSections":[{"title":"The @Query property wrapper","identifiers":["doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/QueryableParameters","doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Query","doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/QueryObservation","doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"],"generated":true}],"schemaVersion":{"major":0,"minor":3,"patch":0},"sections":[],"primaryContentSections":[{"kind":"content","content":[{"anchor":"The-SwiftUI-Environment","level":2,"type":"heading","text":"The SwiftUI Environment"},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"To use "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":", first define a new environment key that grants access to the database."}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"In the example below, we define a new "},{"type":"codeVoice","code":"dbQueue"},{"type":"text","text":" environment key whose value is a GRDB "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#database-queues"},{"type":"text","text":". Some other apps, like the "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/groue\/GRDB.swift\/tree\/master\/Documentation\/DemoApps"},{"type":"text","text":", can choose another name and another type, such as a “database manager” that encapsulates database accesses."}]},{"type":"paragraph","inlineContent":[{"type":"emphasis","inlineContent":[{"type":"text","text":"You are free to choose any type you want"}]},{"type":"text","text":", as long as it is possible to create Combine publishers out of it, the publishers of database values that will feed the SwiftUI views."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/environmentkey"},{"type":"text","text":" describes the procedure:"}]},{"type":"codeListing","syntax":"swift","code":["import GRDB","import SwiftUI","","private struct DatabaseQueueKey: EnvironmentKey {","    \/\/\/ The default dbQueue is an empty in-memory database","    static var defaultValue: DatabaseQueue { DatabaseQueue() }","}","","extension EnvironmentValues {","    var dbQueue: DatabaseQueue {","        get { self[DatabaseQueueKey.self] }","        set { self[DatabaseQueueKey.self] = newValue }","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You will substitute the default empty database with an actual database on disk for your main application:"}]},{"type":"codeListing","syntax":"swift","code":["import SwiftUI","","@main","struct MyApp: App {","    var body: some Scene {","        WindowGroup {","            MyView().environment(\\.dbQueue, \/* some DatabaseQueue on disk *\/)","        }","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You will feed SwiftUI previews with databases that you want to preview:"}]},{"type":"codeListing","syntax":"swift","code":["struct PlayerList_Previews: PreviewProvider {","    static var previews: some View {","        \/\/ Empty list","        PlayerList().environment(\\.dbQueue, \/* empty table of players *\/)","        ","        \/\/ Non-empty list","        PlayerList().environment(\\.dbQueue, \/* non-empty table of players *\/)","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"See the "},{"overridingTitleInlineContent":[{"type":"text","text":"GRDB demo apps"}],"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/groue\/GRDB.swift\/tree\/master\/Documentation\/DemoApps","overridingTitle":"GRDB demo apps"},{"type":"text","text":" for examples of such setups."}]},{"anchor":"Define-a-Queryable-type","level":2,"type":"heading","text":"Define a Queryable type"},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Next, define a "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"},{"type":"text","text":" type that publishes database values."}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"For example, let’s build a Queryable type that observes a database request, and publishes fresh values whenever the database changes:"}]},{"type":"codeListing","syntax":"swift","code":["import Combine","import GRDB","import GRDBQuery","","\/\/\/ Tracks the full list of players","struct PlayersRequest: Queryable {","    static var defaultValue: [Player] { [] }","    ","    func publisher(in dbQueue: DatabaseQueue) -> AnyPublisher<[Player], Error> {","        ValueObservation","            .tracking { db in try Player.fetchAll(db) }","            \/\/ The `.immediate` scheduling feeds the view right on subscription,","            \/\/ and avoids an initial rendering with an empty list:","            .publisher(in: dbQueue, scheduling: .immediate)","            .eraseToAnyPublisher()","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"},{"type":"text","text":" protocol has two requirements: a default value, and a Combine publisher. The publisher is built from the "},{"type":"codeVoice","code":"DatabaseQueue"},{"type":"text","text":" stored in the environment (you’ll adapt this sample code if you prefer another type). In the sample code, the publisher tracks database changes with GRDB "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#valueobservation"},{"type":"text","text":". The default value is used until the publisher publishes its initial value."}]},{"style":"note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"In the above sample code, we make sure the views are "},{"type":"emphasis","inlineContent":[{"type":"text","text":"immediately"}]},{"type":"text","text":" fed with database content with the "},{"type":"codeVoice","code":"scheduling: .immediate"},{"type":"text","text":" option. This prevents any blank state, “flash of missing content”, or unwanted initial animation."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"scheduling: .immediate"},{"type":"text","text":" option should be removed for database accesses that are too slow, because the user interface would be blocked until the database values are fetched."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"If you remove "},{"type":"codeVoice","code":"scheduling: .immediate"},{"type":"text","text":", views are initially fed with the default value, and the database content is notified later, when it becomes available. You can for example use a "},{"type":"codeVoice","code":"nil"},{"type":"text","text":" default value that your view can detect in order to display some waiting indicator, or a "},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/view\/redacted(reason:)"},{"type":"text","text":" placeholder."}]}],"type":"aside","name":"Note"},{"anchor":"Feed-a-SwiftUI-View","level":2,"type":"heading","text":"Feed a SwiftUI View"},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Finally"}]},{"type":"text","text":", you can define a SwiftUI view that automatically updates its content when the database changes:"}]},{"type":"codeListing","syntax":"swift","code":["import GRDBQuery","import SwiftUI","","struct PlayerList: View {","    @Query(PlayersRequest(), in: \\.dbQueue)","    var players: [Player]","    ","    var body: some View {","        List(players) { player in","            HStack {","                Text(player.name)","                Spacer()","                Text(\"\\(player.score) points\")","            }","        }","    }","}"]},{"style":"tip","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Some applications want to use "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" without specifying the key path to the database in each and every view."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"To do so, add somewhere in your application those convenience "},{"type":"codeVoice","code":"Query"},{"type":"text","text":" initializers:"}]},{"type":"codeListing","syntax":"swift","code":["\/\/ Convenience Query initializers for requests","\/\/ that feed from `DatabaseQueue`.","extension Query where Request.DatabaseContext == DatabaseQueue {","    init(_ request: Request) {","        self.init(request, in: \\.dbQueue)","    }","    init(_ request: Binding<Request>) {","        self.init(request, in: \\.dbQueue)","    }","    init(constant request: Request) {","        self.init(constant:request, in: \\.dbQueue)","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"These initializers will streamline your SwiftUI views:"}]},{"type":"codeListing","syntax":"swift","code":["struct PlayerList: View {","    @Query(PlayersRequest()) \/\/ Implicit key path to the database","    var players: [Player]","","    ...","}"]}],"type":"aside","name":"Tip"},{"style":"tip","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"You can further refine your api and turn "},{"type":"codeVoice","code":"@Query(PlayersRequest())"},{"type":"text","text":" into "},{"type":"codeVoice","code":"@Query(.players)"},{"type":"text","text":" by defining an extra extension:"}]},{"type":"codeListing","syntax":"swift","code":["extension Queryable where Self == PlayersRequest {","    static var players: Self { PlayersRequest() }","}","","struct PlayerList: View {","    @Query(.players) var players: [Player]","","    ...","}"]}],"type":"aside","name":"Tip"},{"anchor":"Other-Kinds-of-Publishers","level":2,"type":"heading","text":"Other Kinds of Publishers"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The previous example subscribes to database changes with "},{"overridingTitleInlineContent":[{"type":"text","text":"ValueObservation"}],"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#valueobservation","overridingTitle":"ValueObservation"},{"type":"text","text":", so that the SwiftUI view displays always up-to-date database values. This is a frequent need of applications."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Generally speaking, "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"},{"type":"text","text":" types can build any kind of Combine publisher."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"For example, you can publish one single database value, and ignore future database changes. In the sample code below, the list of players is fetched only once, and delivered to the view asynchronously:"}]},{"type":"codeListing","syntax":"swift","code":["struct PlayersRequest: Queryable {","    static var defaultValue: [Player] { [] }","    ","    func publisher(in dbQueue: DatabaseQueue) -> AnyPublisher<[Player], Error> {","        \/\/ Publishes the list of players, once, asynchronously.","        dbQueue","            .readPublisher { db in try Player.fetchAll(db) }","            .eraseToAnyPublisher()","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"If you need to perform one single fetch, and have the view render the value "},{"type":"emphasis","inlineContent":[{"type":"text","text":"immediately"}]},{"type":"text","text":", prefer this sample code:"}]},{"type":"codeListing","syntax":"swift","code":["struct PlayersRequest: Queryable {","    static var defaultValue: [Player] { [] }","    ","    func publisher(in dbQueue: DatabaseQueue) -> AnyPublisher<[Player], Error> {","        \/\/ Publishes the list of players, once, right on subscription.","        Deferred {","            Result {","                try dbQueue.read { db in try Player.fetchAll(db) }","            }.publisher","        }.eraseToAnyPublisher()","    }","}"]},{"anchor":"Controlling-Request-Observation","level":2,"type":"heading","text":"Controlling Request Observation"},{"type":"paragraph","inlineContent":[{"type":"text","text":"By default, "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" subscribes to the request’s publisher for the whole duration of the presence of the view in the SwiftUI engine."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You can spare resources by cancelling the subscription when views are not on screen: see "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/QueryObservation"},{"type":"text","text":"."}]},{"anchor":"How-to-Handle-Errors","level":2,"type":"heading","text":"How to Handle Errors?"},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"By default, "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" ignores errors"}]},{"type":"text","text":" published by "},{"type":"codeVoice","code":"Queryable"},{"type":"text","text":" types. The SwiftUI views are just not updated whenever an error occurs. If the database is unavailable when the view appears, "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" will just output the default value."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You can restore error handling by publishing a standard "},{"type":"codeVoice","code":"Result"},{"type":"text","text":", as in the example below:"}]},{"type":"codeListing","syntax":"swift","code":["import Combine","import GRDB","import GRDBQuery","","struct PlayersRequest: Queryable {","    typealias Value = Result<[Player], Error>","    static var defaultValue: Value { .success([]) }","    ","    func publisher(in dbQueue: DatabaseQueue) -> AnyPublisher<Value, Never> {","        ValueObservation","            .tracking { db in try Player.fetchAll(db) }","            .publisher(in: dbQueue, scheduling: .immediate)","            .map { players in .success(players) }","            .catch { error in Just(.failure(error)) }","            .eraseToAnyPublisher()","    }","}"]}]}],"variants":[{"paths":["\/documentation\/grdbquery\/gettingstarted"],"traits":[{"interfaceLanguage":"swift"}]}],"identifier":{"url":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/GettingStarted","interfaceLanguage":"swift"},"abstract":[{"type":"text","text":"A step-by-step guide for using "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" in your SwiftUI application."}],"kind":"article","metadata":{"modules":[{"name":"GRDBQuery"}],"role":"collectionGroup","title":"Getting Started with @Query"},"hierarchy":{"paths":[["doc:\/\/GRDBQuery\/documentation\/GRDBQuery"]]},"topicSections":[{"title":"The @Query property wrapper","identifiers":["doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Query"]},{"title":"Feeding @Query with database content","identifiers":["doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"]}],"references":{"https://github.com/groue/GRDB.swift/blob/master/README.md#database-queues":{"title":"DatabaseQueue","titleInlineContent":[{"type":"text","text":"DatabaseQueue"}],"type":"link","identifier":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#database-queues","url":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#database-queues"},"https://developer.apple.com/documentation/swiftui/environmentkey":{"title":"EnvironmentKey documentation","titleInlineContent":[{"type":"text","text":"EnvironmentKey documentation"}],"type":"link","identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/environmentkey","url":"https:\/\/developer.apple.com\/documentation\/swiftui\/environmentkey"},"doc://GRDBQuery/documentation/GRDBQuery/Queryable":{"role":"symbol","title":"Queryable","fragments":[{"kind":"keyword","text":"protocol"},{"kind":"text","text":" "},{"kind":"identifier","text":"Queryable"}],"abstract":[{"type":"codeVoice","code":"Queryable"},{"type":"text","text":" types feed the the "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Query"},{"type":"text","text":" property wrapper."}],"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable","kind":"symbol","type":"topic","navigatorTitle":[{"kind":"identifier","text":"Queryable"}],"url":"\/documentation\/grdbquery\/queryable"},"doc://GRDBQuery/documentation/GRDBQuery":{"role":"collection","title":"GRDBQuery","abstract":[{"type":"text","text":"The SwiftUI companion for GRDB"}],"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery","kind":"symbol","type":"topic","url":"\/documentation\/grdbquery"},"doc://GRDBQuery/documentation/GRDBQuery/QueryableParameters":{"role":"article","title":"Adding Parameters to Queryable Types","abstract":[{"type":"text","text":"Learn how SwiftUI views can configure the database content displayed on screen."}],"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/QueryableParameters","kind":"article","type":"topic","url":"\/documentation\/grdbquery\/queryableparameters"},"https://developer.apple.com/documentation/swiftui/view/redacted(reason:)":{"title":"redacted","titleInlineContent":[{"type":"text","text":"redacted"}],"type":"link","identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/view\/redacted(reason:)","url":"https:\/\/developer.apple.com\/documentation\/swiftui\/view\/redacted(reason:)"},"doc://GRDBQuery/documentation/GRDBQuery/Query":{"role":"symbol","title":"Query","fragments":[{"kind":"keyword","text":"struct"},{"kind":"text","text":" "},{"kind":"identifier","text":"Query"}],"abstract":[{"type":"text","text":"A property wrapper that subscribes to its "},{"type":"codeVoice","code":"Request"},{"type":"text","text":" (a "},{"type":"reference","isActive":true,"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Queryable"},{"type":"text","text":" "},{"type":"text","text":"type), and invalidates a SwiftUI view whenever the database values change."}],"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/Query","kind":"symbol","type":"topic","navigatorTitle":[{"kind":"identifier","text":"Query"}],"url":"\/documentation\/grdbquery\/query"},"https://github.com/groue/GRDB.swift/blob/master/README.md#valueobservation":{"title":"ValueObservation","titleInlineContent":[{"type":"text","text":"ValueObservation"}],"type":"link","identifier":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#valueobservation","url":"https:\/\/github.com\/groue\/GRDB.swift\/blob\/master\/README.md#valueobservation"},"doc://GRDBQuery/documentation/GRDBQuery/QueryObservation":{"role":"symbol","title":"QueryObservation","fragments":[{"kind":"keyword","text":"enum"},{"kind":"text","text":" "},{"kind":"identifier","text":"QueryObservation"}],"abstract":[{"type":"text","text":"A "},{"type":"codeVoice","code":"QueryObservation"},{"type":"text","text":" controls when "},{"type":"codeVoice","code":"@Query"},{"type":"text","text":" property wrappers are observing"},{"type":"text","text":" "},{"type":"text","text":"their requests."}],"identifier":"doc:\/\/GRDBQuery\/documentation\/GRDBQuery\/QueryObservation","kind":"symbol","type":"topic","navigatorTitle":[{"kind":"identifier","text":"QueryObservation"}],"url":"\/documentation\/grdbquery\/queryobservation"},"https://github.com/groue/GRDB.swift/tree/master/Documentation/DemoApps":{"title":"GRDB demo apps","titleInlineContent":[{"type":"text","text":"GRDB demo apps"}],"type":"link","identifier":"https:\/\/github.com\/groue\/GRDB.swift\/tree\/master\/Documentation\/DemoApps","url":"https:\/\/github.com\/groue\/GRDB.swift\/tree\/master\/Documentation\/DemoApps"}}}